# Implementation Plan

- [ ] 1. 扩展现有音频引擎和MIDI处理
  - 基于现有Conductor类添加MIDI输入处理和实时评分功能
  - 扩展AudioKit集成以支持多种播放模式
  - 实现低延迟音频处理管道
  - _Requirements: 1.1, 1.2, 3.1, 3.2_

- [x] 1.1 扩展Conductor类支持MIDI输入
  - 添加MIDI输入监听和事件处理
  - 实现设备自动识别和连接状态管理
  - 创建MIDI映射配置系统
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 1.2 为MIDI连接写属性测试
  - **Property 1: MIDI设备连接一致性**
  - **Property 2: MIDI映射完整性**
  - **Property 3: 连接状态显示一致性**
  - **Validates: Requirements 1.1, 1.2, 1.4, 1.5**

- [x] 1.3 实现实时评分引擎
  - 创建ScoreEngine类处理用户输入评分
  - 实现时间窗口判定逻辑（Perfect/Early/Late/Miss）
  - 添加连击计数和错误惩罚系统
  - _Requirements: 3.2, 3.3, 6.1, 6.4, 6.5_

- [x] 1.4 为评分系统写属性测试 ✅ COMPLETED
  - **Property 8: 实时判定准确性** ✅
  - **Property 9: 评分计算一致性** ✅
  - **Property 19: 连击计数准确性** ✅
  - **Property 20: 错误惩罚一致性** ✅
  - **Validates: Requirements 3.2, 3.3, 6.1, 6.4, 6.5**
  - **Status**: All 17 tests in 4 suites passing

- [ ] 2. 创建数据模型和持久化层
  - 设计Core Data模型支持课程、进度和用户数据
  - 实现CloudKit同步功能
  - 创建本地缓存和离线支持
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 9.2_

- [x] 2.1 实现核心数据模型
  - 创建Lesson、Course、LessonStep、ScoreResult等Core Data实体
  - 实现数据模型之间的关系和约束
  - 添加数据验证和完整性检查
  - _Requirements: 9.2, 9.5_

- [x] 2.2 实现进度管理系统
  - 创建ProgressManager类处理用户进度追踪
  - 实现每日目标、连击和奖杯系统
  - 添加等级和星级计算逻辑
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 2.3 为进度系统写属性测试
  - **Property 21: 进度更新原子性**
  - **Property 22: 每日目标累积性**
  - **Property 23: 连击重置保留性**
  - **Validates: Requirements 7.1, 7.2, 7.4**

- [x] 2.4 实现CloudKit数据同步
  - 配置CloudKit容器和记录类型
  - 实现本地和云端数据同步逻辑
  - 添加冲突解决和错误处理
  - _Requirements: 7.1, 7.5_

- [x] 2.5 为数据同步写单元测试
  - 测试本地数据保存和读取
  - 测试CloudKit同步功能
  - 测试离线模式和数据恢复
  - _Requirements: 7.1, 7.5_

- [x] 3. 实现课程播放引擎
  - 创建LessonEngine类管理课程播放
  - 实现多种播放模式（表现、练习、记忆）
  - 添加BPM控制、循环和等待功能
  - _Requirements: 3.1, 4.1, 4.2, 4.3, 4.4, 8.1, 8.2, 8.3_

- [x] 3.1 创建LessonEngine核心功能
  - 实现课程加载和步骤管理
  - 添加播放控制（开始、暂停、停止）
  - 创建目标事件时间轴系统
  - _Requirements: 3.1, 4.5_

- [x] 3.2 实现练习模式功能
  - 添加BPM滑块控制和自动加速
  - 实现循环区间设置和播放
  - 创建等待模式的暂停/继续逻辑
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [x] 3.3 为播放引擎写属性测试
  - **Property 7: BPM播放准确性**
  - **Property 12: 自动加速递增性**
  - **Property 13: 循环播放边界性**
  - **Property 14: 等待模式暂停准确性**
  - **Validates: Requirements 3.1, 4.1, 4.2, 4.3, 4.4**

- [x] 3.4 实现记忆模式
  - 创建记忆模式的UI隐藏逻辑
  - 实现渐进式引导提示移除
  - 添加黑星成就系统
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 3.5 为记忆模式写属性测试
  - **Property 24: 记忆模式视觉隐藏性**
  - **Property 25: 黑星成就条件性**
  - **Validates: Requirements 8.3, 8.4, 8.5**

- [x] 4. 扩展节拍器功能
  - 基于现有节拍器添加音色选择和细分控制
  - 实现独立音量控制和起拍提示
  - 添加节拍器与课程播放的同步
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 4.1 增强节拍器功能
  - 添加6种节拍器音色选择
  - 实现1/4、1/8、1/16细分设置
  - 创建独立的节拍器音量控制
  - _Requirements: 5.1, 5.2, 5.3, 5.5_

- [x] 4.2 实现起拍提示系统
  - 添加课程开始时的起拍计数
  - 确保起拍提示独立于节拍器开关
  - 实现可配置的起拍小节数
  - _Requirements: 5.4_

- [x] 4.3 为节拍器写属性测试
  - **Property 15: 节拍器音色应用性** ✅
  - **Property 16: 节拍器细分准确性** ✅
  - **Property 17: 起拍提示独立性** ✅
  - **Validates: Requirements 5.2, 5.3, 5.4**
  - **Status**: All 3 tests in 1 suite passing

- [ ] 5. 创建内容浏览和管理系统
  - 实现课程浏览界面和筛选功能
  - 创建内容导入和管理工具
  - 添加标签系统和预览功能
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 9.1, 9.2, 9.3, 9.4, 9.5_

- [ ] 5.1 实现内容浏览界面
  - 创建课程列表和分类显示
  - 添加难度筛选和标签筛选功能
  - 实现课程预览和描述显示
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [ ] 5.2 为内容浏览写属性测试
  - **Property 4: 内容筛选准确性**
  - **Property 5: 标签关联正确性**
  - **Property 6: 新手推荐一致性**
  - **Validates: Requirements 2.2, 2.3, 2.5**

- [ ] 5.3 实现内容管理系统
  - 创建MIDI文件导入和解析功能
  - 实现课程创建和编辑界面
  - 添加内容验证和发布流程
  - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5_

- [ ] 5.4 为内容管理写属性测试
  - **Property 26: MIDI解析转换性**
  - **Property 27: 内容验证完整性**
  - **Validates: Requirements 9.1, 9.2, 9.5**

- [ ] 6. 实现用户界面和交互
  - 重新设计现有UI支持新功能
  - 创建课程播放界面和控制面板
  - 实现进度显示和反馈界面
  - _Requirements: 3.4, 3.5, 6.1, 6.2, 6.3, 7.5, 10.1, 10.2_

- [ ] 6.1 重新设计主界面
  - 扩展现有ContentView支持课程选择
  - 添加导航系统（浏览、播放、进度、设置）
  - 实现响应式布局适配不同屏幕尺寸
  - _Requirements: 2.1, 7.5_

- [ ] 6.2 创建课程播放界面
  - 设计实时反馈显示（Perfect/Early/Late/Miss）
  - 实现进度条和时间轴显示
  - 添加播放控制按钮和模式切换
  - _Requirements: 3.2, 6.1, 6.2_

- [ ] 6.3 实现星级和成就显示
  - 创建星级评分显示组件
  - 实现解锁动画和成就通知
  - 添加进度概览和统计界面
  - _Requirements: 3.4, 3.5, 7.5_

- [ ] 6.4 为UI组件写属性测试
  - **Property 10: 星级阈值正确性**
  - **Property 11: 解锁条件准确性**
  - **Property 18: 判定结果完整性**
  - **Validates: Requirements 3.4, 3.5, 6.1**

- [ ] 7. 实现设置和可访问性功能
  - 创建设置界面和配置管理
  - 实现可访问性选项（高对比模式等）
  - 添加音频设备选择和延迟补偿
  - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ] 7.1 创建设置管理系统
  - 实现设置数据模型和持久化
  - 创建设置界面和控制组件
  - 添加设置验证和应用逻辑
  - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ] 7.2 为设置系统写属性测试
  - **Property 28: 高对比模式转换性**
  - **Property 29: 延迟补偿应用性**
  - **Validates: Requirements 10.1, 10.3**

- [ ] 7.3 实现音频设备管理
  - 添加音频输出设备选择功能
  - 实现蓝牙连接检测和警告
  - 创建延迟测试和校准工具
  - _Requirements: 10.4, 10.5_

- [ ] 7.4 为音频设备管理写单元测试
  - 测试设备切换功能
  - 测试蓝牙检测和警告
  - 测试延迟补偿计算
  - _Requirements: 10.4, 10.5_

- [ ] 8. 集成测试和性能优化
  - 进行端到端集成测试
  - 优化音频延迟和内存使用
  - 实现错误处理和恢复机制
  - _Requirements: All requirements_

- [ ] 8.1 实现错误处理系统
  - 添加音频系统错误恢复
  - 实现数据完整性检查和修复
  - 创建用户友好的错误提示
  - _Requirements: All requirements_

- [ ] 8.2 编写集成测试套件
  - 测试完整的练习流程
  - 测试设备兼容性
  - 测试数据同步一致性
  - _Requirements: All requirements_

- [ ] 8.3 性能优化和调试
  - 优化音频处理延迟
  - 减少内存占用和提高响应性
  - 添加性能监控和日志系统
  - _Requirements: All requirements_

- [ ] 9. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户