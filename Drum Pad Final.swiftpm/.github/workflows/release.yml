name: Release Build

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Create Release Build
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Select Xcode Version
      run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer
      
    - name: Import Code Signing Certificates
      env:
        P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        CERTIFICATE_P12: ${{ secrets.CERTIFICATE_P12 }}
      run: |
        # Create temporary keychain
        security create-keychain -p "" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        
        # Import certificate
        echo $CERTIFICATE_P12 | base64 --decode > certificate.p12
        security import certificate.p12 -k build.keychain -P $P12_PASSWORD -T /usr/bin/codesign
        security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
        
    - name: Install Provisioning Profile
      env:
        PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
      run: |
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        echo $PROVISIONING_PROFILE | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
        
    - name: Build Archive
      run: |
        cd "Drum Pad Final.swiftpm"
        xcodebuild archive \
          -scheme "Drum Pad Final" \
          -destination "generic/platform=iOS" \
          -archivePath "MelodicDrumTrainer.xcarchive" \
          -configuration Release \
          CODE_SIGN_STYLE=Manual \
          PROVISIONING_PROFILE_SPECIFIER="Melodic Drum Trainer Distribution"
          
    - name: Export IPA
      run: |
        cd "Drum Pad Final.swiftpm"
        xcodebuild -exportArchive \
          -archivePath "MelodicDrumTrainer.xcarchive" \
          -exportPath "Export" \
          -exportOptionsPlist "ExportOptions.plist"
          
    - name: Upload to App Store Connect
      env:
        APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
      run: |
        cd "Drum Pad Final.swiftpm"
        xcrun altool --upload-app \
          --type ios \
          --file "Export/Melodic Drum Trainer.ipa" \
          --apiKey $APP_STORE_CONNECT_KEY_ID \
          --apiIssuer $APP_STORE_CONNECT_ISSUER_ID
          
    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          ## Changes in this Release
          - See CHANGELOG.md for detailed changes
          
          ## Installation
          This release has been submitted to the App Store and will be available after Apple's review process.
          
          ## Testing
          - All property-based tests passing (61/61)
          - Full integration test suite validated
          - Performance testing completed on iPad models
        draft: false
        prerelease: false
        
    - name: Upload Release Assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: "Drum Pad Final.swiftpm/Export/Melodic Drum Trainer.ipa"
        asset_name: MelodicDrumTrainer-${{ github.ref_name }}.ipa
        asset_content_type: application/octet-stream